{% extends 'base.html' %}

{% block title %}
    <title>Dashboard</title>
{% endblock %}

{% block script %}
<script type="text/javascript">
    $(document).ready(function(){
        const webSocketBridge = new channels.WebSocketBridge();
        webSocketBridge.connect('/ws/');
        webSocketBridge.listen(function(action, stream) {
            var content = "<div class='message'><div class='message__head'><span class='message__note'></span><span id='user_firstname' class='message__note'>" + action.user_name + "</span></div><div class='message__base'><div class='message__avatar avatar'><a id='user_initial' class='avatar__wrap'>" + action.user_initial + "</a></div><div class='message__textbox'><span id='user_msg' class='message__text'>" + action.message +  "</span></div></div></div>"
            $("#msg_content").append(content);

        $(".friends").each(function() {
            $(this).click(function(e) {
                var user_id = $(this).attr('data-href');
                var url = "/dashboard/fetch_user/"
                $.ajax({
                    url: url,
                    type: 'GET',
                    data: {"user_id": user_id},
                    success: function(response){
                        response = JSON.parse(response)
                        if (response.status) {
                            $("#msg_content").html("");
                            for (i = 0; i < response.data.length; i++) {
                                // fetch the messages in json format response and then append them..
                                var content = "<div class='message'><div class='message__head'><span class='message__note'></span><span id='user_firstname' class='message__note'>" + response.data[i][0] + "</span></div><div class='message__base'><div class='message__avatar avatar'><a id='user_initial' class='avatar__wrap'>" + response.data[i][1] + "</a></div><div class='message__textbox'><span id='user_msg' class='message__text'>" + response.data[i][3] +  "</span></div></div></div>"
                                $("#msg_content").append(content);
                            } 
                        }
                    }
                })
            })
        })

        })
        webSocketBridge.socket.addEventListener('open', function() {
            console.log("Connected to WebSocket");
        })

        webSocketBridge.socket.addEventListener('close', function() {
            console.log("Disonnected from WebSocket");
        })


        $("#textbox").each(function() {
            $(this).keypress(function(e) {
                if (e.keyCode === 13) {
                    e.preventDefault();
                    user_name = document.getElementById("textbox").getAttribute("user-data")
                    user_initial = document.getElementById("textbox").getAttribute("user-initial")
                    var msg = document.getElementById("textbox").value
                    document.getElementById("textbox").value = '';
                    if (msg != "") {
                        user_id = document.getElementById("textbox").getAttribute("user-id")
                        console.log(user_id)
                        webSocketBridge.send({"user_name": user_name, "user_id": user_id, "user_initial": user_initial, "message": msg});

                        var url = "/dashboard/msg_sent/";
                        $.ajax({
                            url: url,
                            type: 'GET',
                            traditional: true,
                            data: {"user_name": user_name, "user_id": user_id, "user_initial": user_initial, "message": msg},
                            success: function(response){
                                response = JSON.parse(response)
                                if (response.status) {
                                    // $("#main_head").html(response.data[0].toUpperCase())
                                    // $("#main_title").html(response.data[1].toUpperCase())
                                }
                            }
                        })
                    }
                }
            })
        })
    }); 
</script>
{% endblock %}


{% block body %}
    <body>
        <nav class="navbar navbar-inverse">
            <div class="container-fluid">
                <div class="navbar-header">
                    <a class="navbar-brand">The CHATBOX</a>
                </div>
                <ul style="float:right" class="nav navbar-nav">
                    <a class="navbar-brand" href="/logout/"><small>Logout</small></a>
                </ul>
            </div>
        </nav>
        <div>
            <div class="modal__dialog">
                <div class="modal__content chat">
                <div class="modal__sidebar">
                    <div class="chat__search search">
                    <div class="search">
                        <div class="search__icon">
                        <i class="fa fa-search" aria-hidden="true"></i>
                        </div>
                        <input type="search" class="search__input" placeholder="Search">
                        <div class="search__icon search__icon_right">
                        <i class="fa fa-pencil-square-o" aria-hidden="true"></i>
                        </div>
                    </div>
                    </div>
                    {% for user in users %}
                        <div class="chat__users">
                        <ul class="users">
                            <li data-href="{{ user.id }}" class="friends users__item users__item_group">
                            <div class="users__avatar avatar">
                                <a id="user_avatar" class="avatar__wrap">
                                    {{ user.first_name|slice:':1'|title }}
                                </a>
                            </div>
                            <span id="user_avatar_name" class="users__note">{{ user.first_name|title }} {{ user.last_name }}</span>
                            <div class="users__counter">
                                <span class="counter">
                                    <!--display the number of unread messages here-->
                                </span>
                            </div>
                            </li>
                            <!--<li class="users__item">-->
                            <!--<div class="users__avatar avatar avatar_online">
                                <a href="#" class="avatar__wrap">
                                <img class="avatar__img" src="http://placehold.it/35x35" width="35" height="35" alt="avatar image">
                                </a>
                            </div>-->
                        </ul>
                        </div>
                    {% endfor %}
                </div>
                <div class="modal__main">
                    <div class="chatbox">
                        <div class="chatbox__row">
                            <div class="head">
                            <div class="head__avatar avatar avatar_larger">
                                <a id="main_head" href="#" class="avatar__wrap">
                                    {{ friend_top.first_name|slice:':1'|upper }}
                                </a>
                            </div>
                            <div id="main_title" class="head__title">{{ friend_top.first_name|upper }}</div>
                            </div>
                            <div id="main_title" class="head__title">{{ message.created_at }}</div>
                        </div>
                        <div class="chatbox__row chatbox__row_fullheight">
                            <div id="msg_content" class="chatbox__content">
                                <!--<div class="message">
                                    <div class="message__head">
                                    <span class="message__note">{{ message.sender.first_name|title }}</span>
                                    <span class="message__note">{{ message.created_at }}</span>
                                    </div>
                                    <div class="message__base">
                                    <div class="message__avatar avatar">
                                        <a href="#" class="avatar__wrap">
                                            {{ message.sender.first_name|slice:':1'|title }}
                                        </a>
                                    </div>
                                    <div class="message__textbox">
                                        <span class="message__text">{{ message.message|safe }}</span>
                                    </div>
                                    </div>
                                </div>-->
                            </div>
                        </div>
                        <div class="chatbox__row">
                            <div class="enter">
                                <div class="enter__submit">
                                    <button class="button button_id_submit" type="submit">
                                        <i class="fa fa-paper-plane" aria-hidden="true"></i>
                                    </button>
                                </div>
                                <div class="enter__textarea">
                                    <textarea id="textbox" user-data="{{ user.first_name|upper }}" user-id="{{ friend_top.id }}" user-initial="{{ user.first_name|slice:':1'|upper }}" name="enterMessage" id="enterMessage" cols="30" rows="2" placeholder="Say message..."></textarea>
                                </div>
                                <div class="enter__icons">
                                    <a href="#" class="enter__icon">
                                    <i class="fa fa-paperclip" aria-hidden="true"></i>
                                    </a>
                                    <a href="#" class="enter__icon">
                                    <i class="fa fa-smile-o" aria-hidden="true"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
{% endblock %}
